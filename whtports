#!/usr/bin/env python3
import sys
import os
import json
import time
import requests
from urllib.parse import quote_plus

CACHE_DIR = os.path.expanduser("~/.cache/whtports")
CACHE_FILE = os.path.join(CACHE_DIR, "iana_ports.json")

def download_iana():
    url = "https://www.iana.org/assignments/service-names-port-numbers/service-names-port-numbers.csv"
    try:
        print("Загрузка данных с IANA...", file=sys.stderr)
        resp = requests.get(url, timeout=15)
        resp.raise_for_status()
        lines = resp.text.splitlines()
        if not lines:
            return {}

        headers = [h.strip() for h in lines[0].split(',')]
        try:
            port_col = headers.index("Port Number")
            proto_col = headers.index("Transport Protocol")
            name_col = headers.index("Service Name")
            desc_col = headers.index("Description")
        except ValueError:
            port_col, proto_col, name_col, desc_col = 1, 2, 0, 3

        port_map = {}
        for line in lines[1:]:
            cols = [c.strip() for c in line.split(',')]
            max_idx = max(port_col, proto_col, name_col, desc_col)
            if len(cols) <= max_idx:
                continue

            port_str = cols[port_col]
            if not port_str or '-' in port_str or not port_str.isdigit():
                continue

            port = int(port_str)
            if port < 0 or port > 65535:
                continue

            proto = cols[proto_col] if proto_col < len(cols) else ""
            name = cols[name_col] if name_col < len(cols) else ""
            desc = cols[desc_col] if desc_col < len(cols) else ""

            if port not in port_map:
                port_map[port] = []

            port_map[port].append({
                "protocol": proto.lower() if proto else "any",
                "name": name,
                "description": desc
            })

        return port_map
    except Exception as e:
        print(f"Ошибка при загрузке IANA: {e}", file=sys.stderr)
        return {}

def load_cache():
    if not os.path.exists(CACHE_FILE):
        return {}
    try:
        with open(CACHE_FILE, "r", encoding="utf-8") as f:
            raw = json.load(f)
        return {int(k): v for k, v in raw.items() if str(k).isdigit()}
    except Exception as e:
        print(f"Ошибка загрузки кэша: {e}", file=sys.stderr)
        return {}

def save_cache(data):
    os.makedirs(CACHE_DIR, exist_ok=True)
    with open(CACHE_FILE, "w", encoding="utf-8") as f:
        json.dump(data, f, ensure_ascii=False, indent=2)

def cache_is_too_old(max_age_days=7):
    if not os.path.exists(CACHE_FILE):
        return True
    try:
        age_seconds = time.time() - os.path.getmtime(CACHE_FILE)
        return age_seconds > (max_age_days * 24 * 60 * 60)
    except (OSError, ValueError):
        return True

def google_url(port):
    return f"https://www.google.com/search?q={quote_plus(f'port {port} IANA assignment')}"

def main():
    if len(sys.argv) != 2 or not sys.argv[1].isdigit():
        print("Использование: whtports <номер_порта>", file=sys.stderr)
        sys.exit(1)

    port = int(sys.argv[1])
    if not (0 <= port <= 65535):
        print("Ошибка: порт должен быть в диапазоне 0–65535", file=sys.stderr)
        sys.exit(1)

    data = load_cache()
    if not data or cache_is_too_old(max_age_days=7):
        fresh_data = download_iana()
        if fresh_data:
            data = fresh_data
            save_cache(data)
        else:
            print("Не удалось обновить базу.", file=sys.stderr)
            print("Поиск в Google:", google_url(port))
            sys.exit(1)

    if port in data:
        records = data[port]
        print(f"Порт {port}:")
        for rec in records:
            parts = []
            if rec["name"]:
                parts.append(rec["name"])
            if rec["description"]:
                parts.append(f"({rec['description']})")
            proto_tag = f"[{rec['protocol'].upper()}]" if rec["protocol"] != "any" else ""
            line = " ".join(parts) if parts else "Нет данных о назначении"
            output = f"  {proto_tag} {line}".strip()
            print(output)
    else:
        print(f"Порт {port} не зарегистрирован в официальной базе IANA.")
        print("Рекомендуем поискать:")
        print(google_url(port))

if __name__ == "__main__":
    main()